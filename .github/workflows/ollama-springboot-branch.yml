name: Generate Spring Boot API (Branch)
on:
  workflow_dispatch:
    # 'types' is only for repository_dispatch; remove for workflow_dispatch
     types: [ollama_auto_gen_code]

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq maven curl

      - name: Install Ollama
        run: curl -fsSL https://ollama.com/install.sh | sh

      - name: Start Ollama
        run: |
          set -e
          ollama serve &
          for i in {1..10}; do
            curl -s http://localhost:11434/api/tags && break
            sleep 2
          done

      - name: Pull model
        run: ollama pull qwen2.5-coder:7b

      - name: Create branch
        run: |
          BRANCH="ai/springboot-api"
          git checkout -B $BRANCH
          echo "BRANCH_NAME=$BRANCH" >> $GITHUB_ENV

      - name: Generate Spring Boot REST API
        run: |
          PROMPT=$(cat <<'EOF'
Generate a minimal, production-ready Spring Boot 3 REST API.

Requirements:
- Java 17
- Maven
- JPA + H2
- Entity: User(id, name, email)
- Layers: controller, service, repository
- Bean Validation
- Global exception handling
- Include pom.xml
- Include main Application class
EOF
)
          curl -s http://localhost:11434/api/generate \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg prompt "$PROMPT" '{
              model: "qwen2.5-coder:7b",
              prompt: $prompt,
              temperature: 0.2,
              num_predict: 1500,
              stream: false
            }')" | jq -r '.response' > output.txt

      - name: Write files
        run: |
          awk '
          /^<.*>$/ {
            gsub(/[<>]/,"",$0)
            file=$0
            next
          }
          /```/ { next }
          {
            if (file) {
              dir=substr(file,1,match(file,"/[^/]*$")-1)
              if (length(dir) > 0) system("mkdir -p " dir)
              print > file
            }
          }' output.txt

      - name: Build project
        run: mvn clean test

      - name: Commit and push branch
        run: |
          git config user.name "ollama-bot"
          git config user.email "ollama-bot@users.noreply.github.com"
          git add .
          git diff-index --quiet HEAD || git commit -m "AI: generate Spring Boot REST API"
          git push origin $BRANCH_NAME
