name: Trigger on JIRA Issue Create
on:
  repository_dispatch:
    types: [auto_gen_code]

jobs:
  print-jira-details:
    runs-on: ubuntu-latest
    steps:
      - name: Print JIRA payload
        run: |
          echo "Issue Key: ${{ github.event.client_payload.issue_key }}"
          echo "Summary: ${{ github.event.client_payload.summary }}"
          echo "Reporter: ${{ github.event.client_payload.reporter }}"
  handle-jira:
    runs-on: ubuntu-latest
    needs: print-jira-details
    steps:
      - name: Create New ${{ github.event.client_payload.issue_key }} branch
        run: |
          echo "Issue Key: ${{ github.event.client_payload.issue_key }}"
          echo "Summary: ${{ github.event.client_payload.summary }}"
          echo "Reporter: ${{ github.event.client_payload.reporter }}"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create and push branch
        run: |
          git checkout -b "${{ github.event.client_payload.issue_key }}"
          git push origin "${{ github.event.client_payload.issue_key }}"
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install openai

      - name: Generate code with OpenAI
        id: gencode
        env:
          OPENAI_API_KEY: "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"
          INPUT_ISSUE_KEY: ${{ github.event.client_payload.issue_key }}
          INPUT_ISSUE_TITLE: ${{ github.event.client_payload.issue_title }}
          INPUT_ISSUE_DESCRIPTION: ${{ github.event.client_payload.issue_description }}
        run: |
          python3 <<'EOF'
          import os, json
          from openai import OpenAI

          client = OpenAI(api_key=os.environ["OPENAI_API_KEY"])

          issue = {
              "key": os.environ["INPUT_ISSUE_KEY"],
              "title": os.environ["INPUT_ISSUE_TITLE"],
              "description": os.environ["INPUT_ISSUE_DESCRIPTION"],
          }

          prompt = f"""
          You are an automated code generator.

          Based on the following JIRA issue, generate high-quality code.
          Output ONLY file paths and contents in a deterministic format.

          JIRA Issue:
          {json.dumps(issue, indent=2)}
          """

          response = client.responses.create(
              model="gpt-4.1",
              input=prompt,
          )

          with open("autogen_output.txt", "w") as f:
              f.write(response.output_text)

          print("Code generation complete.")
          EOF

      - name: Apply generated code to repo
        run: |
          bash scripts/apply_autogen_files.sh autogen_output.txt

      - name: Commit files
        run: |
          git config user.name "auto-bot"
          git config user.email "bot@example.com"
          git add .

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "${{ github.event.inputs.issue_key }}: auto-generated code"
          git push origin "${{ steps.branch.outputs.branch }}"

      - name: Create Pull Request
        uses: repo-sync/pull-request@v2
        with:
          source_branch: ${{ steps.branch.outputs.branch }}
          destination_branch: main
          pr_title: "${{ github.event.inputs.issue_key }} â€“ Auto-generated implementation"
          pr_body: |
            ðŸ¤– Auto-generated from JIRA issue

            **Issue:** ${{ github.event.inputs.issue_key }}
            **Title:** ${{ github.event.inputs.issue_title }}

            **Description:**
            ${{ github.event.inputs.issue_description }}
